<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HUD — Dark Glass Road</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    /* ====== Dark Glass Road (production HUD) — C3 lane, USA theme option ====== */
    :root{
      --glass-bg: rgba(24,26,31,0.70);
      --glass-border: rgba(255,255,255,0.10);
      --text: #ffffff;
      --eta: #e5e7eb;

      /* Lane + fill */
      --lane-track: rgba(255,255,255,0.10);
      --lane-h: 24px;         /* L2 */
      --lane-fill-cobalt-1: rgba(88,149,255,0.95);
      --lane-fill-cobalt-2: rgba(58,116,255,0.95);
      --lane-fill-cobalt-3: rgba(34,84,210,0.95);

      /* Vehicle sizes (updated) */
      --veh-h: 56px;          /* BUS height — B4 */
      --plane-h: 32px;        /* PLANE smaller (was 48 → now 40) */
      --plane-hover: 5px;    /* hover above lane */

      /* Stars */
      --star: rgba(255,255,255,0.95);
      --star-dim: rgba(255,255,255,0.60);
    }

    html,body{height:100%;margin:0;background:transparent;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    #root{position:fixed;inset:0;}
    .stage{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;padding:18px}

    /* Pill */
    .pill{position:relative; z-index:6; display:flex;flex-direction:column;gap:6px; min-width:min(92vw,720px); padding:12px 16px;
          border-radius:999px; background:var(--glass-bg); color:var(--text); border:1px solid var(--glass-border); backdrop-filter:blur(10px);
          box-shadow: 0 8px 22px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.06);
          opacity:0; transform: translateY(8px) scale(.985); animation: intro .55s cubic-bezier(.21,.9,.26,.99) forwards; }
    @keyframes intro{to{opacity:1; transform: translateY(0) scale(1);}}

    /* Stars */
    .stars{ position:absolute; inset:-32px; pointer-events:none; opacity:0; transition: opacity .4s ease; z-index:5; }
    .stars.active{ opacity:1; }
    .star{ position:absolute; width:3px; height:3px; border-radius:50%;
           background: var(--star); box-shadow: 0 0 6px rgba(255,255,255,.7); opacity:.95;
           animation: twinkle 3.2s ease-in-out infinite; }
    .star.dim{ background: var(--star-dim); box-shadow: 0 0 4px rgba(255,255,255,.45); opacity:.7; animation-duration: 4.6s; }
    @keyframes twinkle{ 0%,100%{opacity:.6} 50%{opacity:1} }

    /* Top row */
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .states{font-weight:700;letter-spacing:.2px;font-size:16px; text-shadow: 0 1px 2px rgba(0,0,0,.25);}
    .eta{font-weight:700;color:var(--eta);font-size:15px; transition: opacity .2s ease; }
    .eta.hidden{ opacity:0; visibility:hidden; }

    /* Lane — C3 clean glass depth */
    .laneBox{ position:relative; }
    .lane{
      position:relative;width:700px;max-width:92vw;height: var(--lane-h);
      border-radius:999px; overflow:visible; /* allow plane to float */
      background: var(--lane-track);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), inset 0 8px 18px rgba(0,0,0,.25);
    }
    .lane::before{ content:""; position:absolute; inset:0; border-radius:inherit;
      background: linear-gradient(180deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 45%, rgba(0,0,0,.15) 100%);
      pointer-events:none; mix-blend-mode:soft-light;
    }
    .lane::after{ content:""; position:absolute; inset:0; border-radius:inherit;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25), inset 0 -1px 0 rgba(0,0,0,.35);
      pointer-events:none;
    }

    /* Fill (default cobalt) */
    .fill{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background: linear-gradient(180deg, var(--lane-fill-cobalt-1) 0%, var(--lane-fill-cobalt-2) 55%, var(--lane-fill-cobalt-3) 100%);
      border-radius: 999px;
    }
    .fill::before{ content:""; position:absolute; inset:0; border-radius:inherit;
      background: linear-gradient(180deg, rgba(255,255,255,.35) 0, rgba(255,255,255,0) 40%);
      mix-blend-mode:screen; opacity:.45; pointer-events:none;
    }

    /* USA theme */
    [data-theme="usa"] .fill{
      background:
        repeating-linear-gradient(90deg,
          #e11d2a 0 28px, #ffffff 28px 56px, #1e3a8a 56px 84px),
        linear-gradient(180deg, rgba(255,255,255,.25) 0, rgba(255,255,255,0) 40%);
      background-size: 168px 100%, 100% 100%;
      animation: usaSlide 6s linear infinite;
    }
    @keyframes usaSlide{ from{ background-position:0 0, 0 0 } to{ background-position:-168px 0, 0 0 } }

    /* Vehicle (bus in-lane; plane above) */
    .vehWrap{ position:absolute; left:0; top:50%; transform: translate(-50%, -50%); }
    .bus{ height: var(--veh-h); display:none; user-select:none; filter: drop-shadow(0 1px 2px rgba(0,0,0,.5)); }
    .plane{
      font-size: var(--plane-h); display:none; filter: drop-shadow(0 1px 2px rgba(0,0,0,.5));
      position: relative; top: calc(-1 * var(--plane-hover)); z-index: 2;
    }
    .shadow{
      position:absolute; left:50%; top:50%;
      width: calc(var(--veh-h) * 1.6); height: calc(var(--veh-h) * 0.5);
      transform: translate(-50%, -45%);
      background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0.0) 70%);
      filter: blur(1px); opacity:.85; pointer-events:none;
    }

    /* Sparkle trail */
    .sparkle{ position:absolute; width:3px; height:3px; border-radius:50%; background: rgba(255,255,255,.9);
              box-shadow: 0 0 6px rgba(255,255,255,.55); opacity:0; pointer-events:none; }

    /* Arrival stamp + confetti */
    .stamp{ position:absolute; top:-22px; right:12px; font-weight:800; font-size:12px; letter-spacing:.6px;
            padding:4px 8px; border:2px solid #A8FFB6; color:#A8FFB6; border-radius:8px; transform: scale(.85) rotate(-6deg);
            opacity:0; background: rgba(0,0,0,0.30); box-shadow: 0 8px 22px rgba(0,0,0,.25); z-index:7; }
    .stamp.show{ animation: stampIn 220ms cubic-bezier(.2,.9,.2,1) forwards; }
    @keyframes stampIn{ 0%{ transform: scale(.7) rotate(-10deg); opacity:0 } 60%{ transform: scale(1.05) rotate(-4deg); opacity:1 } 100%{ transform: scale(1) rotate(-6deg); opacity:1 } }

    .confetti{ position:absolute; inset:0; overflow:hidden; pointer-events:none; z-index:7; }
    .piece{ position:absolute; width:6px; height:8px; opacity:0; }

    /* Night mode */
    [data-mode="night"] .pill{ background: rgba(14,16,20,0.70); }
    [data-mode="night"] .fill{ box-shadow: 0 0 8px rgba(58,116,255,0.55); }

    /* Auto hide after 60s */
    .hideOut{ animation: hideOut 420ms ease forwards; }
    @keyframes hideOut{ to{ opacity:0; transform: translateY(6px) scale(.98); } }
  </style>
</head>
<body data-mode="day" data-theme="classic">
  <div id="root">
    <div class="stage">
      <div class="pill" id="pill">
        <!-- Stars -->
        <div class="stars" id="stars"></div>

        <div class="top">
          <div class="states"><span id="from">From</span> → <span id="to">To</span></div>
          <div class="eta" id="eta">ETA —</div>
        </div>

        <div class="laneBox">
          <div class="lane" id="lane">
            <div class="fill" id="fill"></div>
            <div class="vehWrap" id="veh">
              <div class="shadow" id="shadow"></div>
              <img id="bus" class="bus" alt="" src="assets/bus.png" />
              <span id="plane" class="plane">✈️</span>
            </div>
          </div>
          <div class="stamp" id="stamp">ARRIVED</div>
          <div class="confetti" id="confetti"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    import { ref as dbRef } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0gJnv1eD4SeXMCRHtFNiHOt122Rbz4XQ",
      authDomain: "subathon-tracker.firebaseapp.com",
      databaseURL: "https://subathon-tracker-default-rtdb.firebaseio.com",
      projectId: "subathon-tracker",
      storageBucket: "subathon-tracker.appspot.com",
      messagingSenderId: "196475311335",
      appId: "1:196475311335:web:ac4411584ea074613ffe42",
      measurementId: "G-ETY652FL4L"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // URL fallbacks (DB wins if present)
    const url = new URL(location.href);
    const room = url.searchParams.get('room') || 'marathon-pill-tracker';
    const urlMode    = (url.searchParams.get('mode')||'').toLowerCase();
    const urlStars   = url.searchParams.get('stars');
    const urlSparkle = url.searchParams.get('sparkle');
    const urlTheme   = (url.searchParams.get('theme')||'').toLowerCase();

    document.body.setAttribute('data-mode', urlMode || 'day');

    // Server time
    const offsetRef = dbRef(db, ".info/serverTimeOffset");
    let serverOffset = 0;
    onValue(offsetRef, s => serverOffset = s.val() || 0);
    const now = () => Date.now() + serverOffset;

    // UI refs
    const pill = document.getElementById('pill');
    const starField = document.getElementById('stars');
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');
    const etaEl = document.getElementById('eta');
    const lane = document.getElementById('lane');
    const fillEl = document.getElementById('fill');
    const veh = document.getElementById('veh');
    const busEl = document.getElementById('bus');
    const planeEl = document.getElementById('plane');
    const shadowEl = document.getElementById('shadow');
    const stamp = document.getElementById('stamp');
    const confetti = document.getElementById('confetti');

    // Stars
    function seedStars(count=110){
      starField.innerHTML = "";
      const rect = pill.getBoundingClientRect();
      const w = Math.max(rect.width + 400, 900);
      const h = rect.height + 180;
      for (let i=0;i<count;i++){
        const s = document.createElement('div');
        s.className = 'star' + (Math.random()<0.45 ? ' dim' : '');
        s.style.left = (rect.left - 200 + Math.random()*w) + 'px';
        s.style.top  = (rect.top  -  90 + Math.random()*h) + 'px';
        s.style.animationDelay = (Math.random()*3)+'s';
        starField.appendChild(s);
      }
    }
    function initStars(mode, starsOn){
      if (mode === 'night' && starsOn){ seedStars(110); starField.classList.add('active'); }
      else { starField.classList.remove('active'); }
    }

    // Live state
    let state = null, hideTimeout = null;
    let FLAGS = { starsOn: (urlStars !== '0'), sparkleOn: (urlSparkle !== '0') };
    let START_OFFSET = 0; // 0..1 (vehicle starting position)

    onValue(ref(db, `overlays/${room}/state`), snap => {
      state = snap.val() || {};

      // UI prefs from DB (fallback to URL params)
      const mode    = (state.mode || urlMode || 'day').toLowerCase();
      const theme   = (state.theme || urlTheme || 'classic').toLowerCase();
      FLAGS.starsOn   = (typeof state.stars   === 'boolean') ? state.stars   : (urlStars   !== '0');
      FLAGS.sparkleOn = (typeof state.sparkle === 'boolean') ? state.sparkle : (urlSparkle !== '0');
      START_OFFSET = Math.max(0, Math.min(1, Number(state.startOffsetPct ?? 0)));

      document.body.setAttribute('data-mode', mode);
      document.body.setAttribute('data-theme', theme);
      initStars(mode, FLAGS.starsOn);

      // Labels & vehicle
      fromEl.textContent = state.from || "From";
      toEl.textContent   = state.to   || "To";
      setVehicle(state.vehicle);

      render(true);
    });

    function setVehicle(v){
      if (!v || v.mode === "emoji") {
        planeEl.style.display = "inline";
        busEl.style.display   = "none";
        planeEl.textContent   = (v && v.emoji) || "✈️";
      } else {
        busEl.style.display   = "inline";
        planeEl.style.display = "none";
        busEl.src             = v.image || "assets/bus.png";
      }
    }

    function fmt(ms){
      if (ms <= 0) return "ARRIVED";
      const s = Math.ceil(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s%60;
      if (h>0) return `${h}h ${m}m`;
      if (m>0) return `${m}m ${ss}s`;
      return `${ss}s`;
    }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    let lastX = 0, lastTs = 0;
    function render(immediate=false){
      if (!state) return;
      const baseline = (state.baselineSec||0)*1000;

      let remaining = 0;
      if (state.paused) remaining = Math.max(0, state.pausedRemaining||0);
      else remaining = Math.max(0, (state.endAt||0) - now());

      if (remaining <= 0){
        etaEl.textContent = "";
        etaEl.classList.add('hidden');
        fillEl.style.width = "100%";
        moveVehicle(1, immediate);
        if (!stamp.classList.contains('show')) { stamp.classList.add('show'); burstConfetti(); }
        if (!hideTimeout){ hideTimeout = setTimeout(()=> pill.classList.add('hideOut'), 60_000); }
        return;
      } else {
        etaEl.classList.remove('hidden');
        pill.classList.remove('hideOut');
        stamp.classList.remove('show');
        if (hideTimeout){ clearTimeout(hideTimeout); hideTimeout = null; }
      }

      etaEl.textContent = "ETA " + fmt(remaining);
      const elapsed = baseline - remaining;
      const p = baseline<=0 ? 0 : clamp01(elapsed / baseline);

      // Map progress into offset domain: p' = start + p*(1-start)
      const pGlobal = START_OFFSET + p * (1 - START_OFFSET);

      fillEl.style.width = (pGlobal*100).toFixed(2)+"%";
      moveVehicle(pGlobal, immediate);
    }

    function getVehHalf(){
      const el = (busEl.style.display!=='none') ? busEl : planeEl;
      const w = el.getBoundingClientRect().width || parseFloat(getComputedStyle(el).fontSize) || 40;
      return Math.round(w/2);
    }

    function moveVehicle(pGlobal, immediate=false){
      const laneW = lane.clientWidth;
      let x = Math.round(pGlobal * laneW);

      // clamp so vehicle never clips outside
      const half = getVehHalf();
      const margin = Math.max(8, half);
      x = Math.max(margin, Math.min(x, laneW - margin));
      veh.style.left = x + 'px';

      // speed-aware shadow; scale to visible element width
      const ts = performance.now();
      const dt = Math.max(16, ts - lastTs);
      const dx = x - lastX;
      lastX = x; lastTs = ts;

      const visibleEl = (busEl.style.display!=='none') ? busEl : planeEl;
      const baseW = visibleEl.getBoundingClientRect().width || 40;

      const speed = Math.min(1, Math.abs(dx) / Math.max(1, laneW) * 16 * (1000/dt));
      const w = baseW * (1.6 + 0.4*speed);
      const h = baseW * (0.50 + 0.10*speed);
      shadowEl.style.width = w + 'px';
      shadowEl.style.height = h + 'px';
      shadowEl.style.opacity = String(0.7 + speed*0.15);

      if (FLAGS.sparkleOn) spawnSparkle(x);
    }

    function spawnSparkle(x){
      if (Math.random() > 0.35) return;
      const n = 1 + (Math.random()<0.4?1:0);
      for (let i=0;i<n;i++){
        const sp = document.createElement('div');
        sp.className = 'sparkle';
        const offset = -8 - Math.random()*18;
        const yJitter = (Math.random()*8 - 4);
        sp.style.left = (x + offset) + 'px';
        sp.style.top  = (lane.clientHeight/2 + yJitter) + 'px';
        sp.style.opacity = '1';
        lane.appendChild(sp);
        const drift = -6 - Math.random()*10;
        const up = (Math.random()*4 - 2);
        const life = 300 + Math.random()*220;
        const start = performance.now();
        const tick = (t)=>{
          const k = (t - start)/life;
          if (k>=1){ sp.remove(); return; }
          sp.style.transform = `translate(${drift*k}px, ${up*k}px)`;
          sp.style.opacity = String(1 - k);
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      }
    }

    function burstConfetti(){
      confetti.innerHTML = "";
      const colors = ['#3A74FF','#A8FFB6','#F5D06F','#FF7A7A','#9AD0FF'];
      const N = 12;
      for (let i=0;i<N;i++){
        const piece = document.createElement('div');
        piece.className='piece';
        piece.style.background = colors[i%colors.length];
        piece.style.left = (lane.clientWidth - 40 + Math.random()*30) + 'px';
        piece.style.top = ( -6 + Math.random()*6 ) + 'px';
        confetti.appendChild(piece);
        const life = 800 + Math.random()*500;
        const dx = (Math.random()*60 - 30);
        const dy = (Math.random()*46 + 24);
        const rot = (Math.random()*260 - 130);
        const start = performance.now();
        const tick = (t)=>{
          const k = (t - start)/life;
          if (k>=1){ piece.remove(); return; }
          piece.style.transform = `translate(${dx*k}px, ${dy*k}px) rotate(${rot*k}deg)`;
          piece.style.opacity = String(1 - k);
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      }
    }

    setInterval(()=>render(false), 250);
  </script>
</body>
</html>
