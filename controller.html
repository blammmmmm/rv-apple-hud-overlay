<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controller ‚Äî Marathon Pill</title>
  <style>
    :root{ --bg:#0b0f14; --card:#11161d; --text:#e5e7eb; --muted:#9aa6b2; --accent:#3A74FF; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:24px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #212b36;border-radius:12px;padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3340;background:#0d131a;color:#fff}
    button{padding:10px 14px;border-radius:10px;border:1px solid #304057;background:#132033;color:#fff;cursor:pointer}
    button.primary{background:var(--accent);border-color:#2f64de}
    .row{display:flex;gap:8px;align-items:center}
    .row>div{flex:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:#94a3b8}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1520;border:1px solid #283243;font-size:12px;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Controller ‚Äî Marathon Travel ETA</h2>
    <div class="grid">
      <div class="card">
        <label>From / To</label>
        <div class="row">
          <input id="from" placeholder="From" />
          <input id="to" placeholder="To" />
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="updateLabels" class="primary">Update Labels</button>
        </div>
      </div>

      <div class="card">
        <label>Duration</label>
        <div class="row">
          <input id="hrs" type="number" min="0" value="0" placeholder="Hours"/>
          <input id="mins" type="number" min="0" value="2" placeholder="Minutes"/>
        </div>
        <div class="actions" style="margin-top:10px">
          <button id="start" class="primary">Start / Set</button>
          <button id="pause">Pause</button>
          <button id="resume">Resume</button>
          <button id="reset">Reset</button>
        </div>
        <div class="actions" style="margin-top:6px">
          <button id="add1">+1m</button>
          <button id="sub1">-1m</button>
          <button id="add5">+5m</button>
          <button id="sub5">-5m</button>
        </div>
      </div>

      <div class="card">
        <label>Vehicle</label>
        <div class="actions">
          <button id="busBtn">üöå Bus (PNG)</button>
          <button id="planeBtn">‚úàÔ∏è Plane (emoji)</button>
        </div>
        <div class="hint" style="margin-top:8px">Bus path must be <span class="pill">assets/bus.png</span></div>
      </div>

      <div class="card">
        <label>HUD Theme & FX</label>
        <div class="row" style="margin-bottom:8px">
          <div>
            <label>Mode</label>
            <select id="modeSel">
              <option value="day">Day</option>
              <option value="night">Night</option>
            </select>
          </div>
          <div>
            <label>Theme</label>
            <select id="themeSel">
              <option value="classic">Classic (Cobalt)</option>
              <option value="usa">USA stripes</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="actions"><button id="starsToggle">Toggle Stars</button></div>
          <div class="actions"><button id="sparkleToggle">Toggle Sparkle</button></div>
        </div>
        <div class="hint" style="margin-top:8px">These update the HUD instantly via Firebase (no URL params needed).</div>
      </div>
    </div>

    <div style="margin-top:14px" class="hint">
      Room: <span id="roomLbl" class="pill"></span>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    import { ref as dbRef } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0gJnv1eD4SeXMCRHtFNiHOt122Rbz4XQ",
      authDomain: "subathon-tracker.firebaseapp.com",
      databaseURL: "https://subathon-tracker-default-rtdb.firebaseio.com",
      projectId: "subathon-tracker",
      storageBucket: "subathon-tracker.appspot.com",
      messagingSenderId: "196475311335",
      appId: "1:196475311335:web:ac4411584ea074613ffe42",
      measurementId: "G-ETY652FL4L"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url = new URL(location.href);
    const room = url.searchParams.get('room') || 'marathon-pill-tracker';
    document.getElementById('roomLbl').textContent = room;

    const offsetRef = dbRef(db, ".info/serverTimeOffset");
    let serverOffset = 0; onValue(offsetRef, s => serverOffset = s.val() || 0);
    const now = () => Date.now() + serverOffset;

    const SREF = ref(db, `overlays/${room}/state`);

    // --- UI refs
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');
    const hrs = document.getElementById('hrs');
    const mins = document.getElementById('mins');
    const modeSel = document.getElementById('modeSel');
    const themeSel = document.getElementById('themeSel');
    const starsBtn = document.getElementById('starsToggle');
    const sparkleBtn = document.getElementById('sparkleToggle');

    // --- State watcher (to reflect stars/sparkle button labels)
    let cache = {};
    onValue(SREF, snap => {
      cache = snap.val() || {};
      // update toggle button labels
      starsBtn.textContent = (cache.stars===false? 'Enable Stars' : 'Disable Stars');
      sparkleBtn.textContent = (cache.sparkle===false? 'Enable Sparkle' : 'Disable Sparkle');
      if (cache.mode) modeSel.value = cache.mode;
      if (cache.theme) themeSel.value = cache.theme;
      if (cache.from) fromEl.value = cache.from;
      if (cache.to) toEl.value = cache.to;
    });

    // --- Label updates
    document.getElementById('updateLabels').onclick = async ()=>{
      await update(SREF, { from: fromEl.value||'', to: toEl.value||'', updatedAt: now() });
    };

    // --- Countdown controls
    document.getElementById('start').onclick = async ()=>{
      const totalSec = (parseInt(hrs.value||'0',10)*3600) + (parseInt(mins.value||'0',10)*60);
      const t0 = now();
      await update(SREF, {
        baselineSec: totalSec,
        startedAt: t0,
        endAt: t0 + totalSec*1000,
        paused: false,
        pausedAt: 0,
        pausedRemaining: 0,
        updatedAt: now()
      });
    };
    document.getElementById('pause').onclick = async ()=>{
      if (cache.paused) return;
      const rem = Math.max(0, (cache.endAt||0) - now());
      await update(SREF, { paused:true, pausedAt: now(), pausedRemaining: rem, updatedAt: now() });
    };
    document.getElementById('resume').onclick = async ()=>{
      if (!cache.paused) return;
      const t0 = now();
      const rem = Math.max(0, cache.pausedRemaining||0);
      await update(SREF, { paused:false, pausedAt:0, endAt: t0 + rem, updatedAt: now() });
    };
    document.getElementById('reset').onclick = async ()=>{
      await update(SREF, { paused:false, pausedAt:0, pausedRemaining:0, startedAt:0, endAt:0, updatedAt: now() });
    };

    // Add/Sub minutes
    async function addMinutes(n){
      const target = (cache.paused ? (now() + (cache.pausedRemaining||0)) : (cache.endAt||now()));
      const end = Math.max(now(), target + n*60*1000);
      const rem = Math.max(0, end - now());
      await update(SREF, {
        endAt: end,
        pausedRemaining: cache.paused ? rem : 0,
        updatedAt: now()
      });
    }
    document.getElementById('add1').onclick = ()=>addMinutes(1);
    document.getElementById('sub1').onclick = ()=>addMinutes(-1);
    document.getElementById('add5').onclick = ()=>addMinutes(5);
    document.getElementById('sub5').onclick = ()=>addMinutes(-5);

    // --- Vehicle
    document.getElementById('busBtn').onclick = async ()=>{
      await update(SREF, { vehicle: { mode:'image', image:'assets/bus.png' }, updatedAt: now() });
    };
    document.getElementById('planeBtn').onclick = async ()=>{
      await update(SREF, { vehicle: { mode:'emoji', emoji:'‚úàÔ∏è' }, updatedAt: now() });
    };

    // --- Theme & FX
    modeSel.onchange = ()=> update(SREF, { mode: modeSel.value, updatedAt: now() });
    themeSel.onchange= ()=> update(SREF, { theme: themeSel.value, updatedAt: now() });
    starsBtn.onclick  = ()=> update(SREF, { stars: !(cache.stars===false), updatedAt: now() });
    sparkleBtn.onclick= ()=> update(SREF, { sparkle: !(cache.sparkle===false), updatedAt: now() });
  </script>
</body>
</html>
