<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HUD Controller ‚Äî FINAL (Timer + Autosuggest + Helpers)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:#0b0e13; color:#e5e7eb; margin:0; padding:24px; }
    .wrap { max-width: 920px; margin:0 auto; display:grid; gap:16px; }
    .card { background:#121722; border:1px solid #283041; border-radius:14px; padding:16px; }
    h1 { font-size:18px; margin:0 0 8px; }
    label { display:block; font-size:12px; color:#9fb0c7; margin-bottom:6px; }
    input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334055; background:#0f131c; color:#e5e7eb; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #2b374a; background:#1b2433; color:#e5e7eb; cursor:pointer; }
    button:hover { background:#223047; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; align-items:end; }
    .col-3 { grid-column: span 3; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
    .subtle-sep { margin:12px 0; height:1px; background:#222a35; border-radius:2px; }
    .muted { color:#9fb0c7; font-size:12px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // Room from URL (?room=...), defaults to your chosen room
    const ROOM = new URLSearchParams(location.search).get('room') || 'marathon-pill-tracker';

    // Your Firebase (same as overlay)
    const firebaseConfig = {
      apiKey: "AIzaSyB0gJnv1eD4SeXMCRHtFNiHOt122Rbz4XQ",
      authDomain: "subathon-tracker.firebaseapp.com",
      databaseURL: "https://subathon-tracker-default-rtdb.firebaseio.com",
      projectId: "subathon-tracker",
      storageBucket: "subathon-tracker.appspot.com",
      messagingSenderId: "196475311335",
      appId: "1:196475311335:web:ac4411584ea074613ffe42",
      measurementId: "G-ETY652FL4L"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const stateRef = ref(db, `overlays/${ROOM}/state`);

    const $ = id => document.getElementById(id);
    const now = () => Date.now();

    // Autosuggest list you provided
    const PRESET_PLACES = [
      "Los Angeles, CA","Las Vegas, NV","Flagstaff, AZ","Albuquerque, NM","Denver, CO","Cheyenne, WY","Salt Lake City, UT","Boise, ID","Portland, OR","Seattle, WA","Juneau, AK","Billings, MT","Fargo, ND","Minneapolis, MN","Sioux Falls, SD","Omaha, NE","Des Moines, IA","Milwaukee, WI","Chicago, IL","Detroit, MI","Burlington, VT","Portland, ME","Manchester, NH","Boston, MA","Providence, RI","Bridgeport, CT","New York, NY","Princeton, NJ","Philadelphia, PA","Wilmington, DE","Baltimore, MD","Virginia Beach, VA","Charleston, NC","Jacksonville, FL","Greenville, NC","Charleston, WV","Columbus, OH","Indianapolis, IN","Louisville, KY","Nashville, TN","Atlanta, GA","Birmingham, AL","Kansas City, MO","Wichita, KS","Oklahoma City, OK","Little Rock, AK","Jackson, MS","New Orleans, LA","Houston, TX","Honolulu, HI"
    ];
    const LS_KEY="rv_places_history";
    function loadHistory(){try{return JSON.parse(localStorage.getItem(LS_KEY)||"[]");}catch{return[]}}
    function saveHistory(l){try{localStorage.setItem(LS_KEY,JSON.stringify(l));}catch{}}
    function merge(a,b){return [...new Set([...a,...b])].sort();}
    function rebuildList(){
      const list=$("#placesList"); list.innerHTML="";
      merge(PRESET_PLACES,loadHistory()).forEach(v=>{
        const op=document.createElement("option");
        op.value=v; list.appendChild(op);
      });
    }
    function addHist(v){v=(v||"").trim(); if(!v)return;
      const h=loadHistory(); if(!h.includes(v)){h.push(v); saveHistory(h); rebuildList();}
    }

    async function read(){const s=await get(stateRef); return s.val()||{};}

    window.addEventListener('DOMContentLoaded',()=>{
      rebuildList();

      // Trip labels
      $("#setLabels").onclick = async () => {
        const cur=await read();
        const from=$("#from").value.trim()||cur.from||"‚Äî";
        const to  =$("#to").value.trim()  ||cur.to  ||"‚Äî";
        await update(stateRef,{ from, to, updatedAt: now() });
        addHist(from); addHist(to);
      };
      $("#swap").onclick = ()=>{ const f=$("#from").value, t=$("#to").value; $("#from").value=t; $("#to").value=f; };
      $("#chain").onclick = ()=>{ $("#from").value=$("#to").value.trim(); $("#to").value=""; };

      // Timer: Start/Set
      $("#startSet").onclick = async () => {
        const h = parseInt($("#hours").value,10)||0;
        const m = Math.min(59, Math.max(0, parseInt($("#minutes").value,10)||0));
        const base = h*3600 + m*60;
        const s = now(), e = s + base*1000;
        await update(stateRef, {
          baselineSec: base, startedAt: s, endAt: e,
          paused: false, pausedAt: 0, pausedRemaining: 0,
          updatedAt: now()
        });
      };

      // +/‚àí minutes
      document.querySelectorAll("button[data-min]").forEach(b=>{
        b.onclick = async () => {
          const cur=await read(), d=parseInt(b.getAttribute("data-min"),10)||0;
          const base = Math.max(0, (cur.baselineSec||0) + d*60);
          if (cur.paused){
            const rem = Math.max(0, (cur.pausedRemaining||0) + d*60*1000);
            return update(stateRef,{ baselineSec: base, pausedRemaining: rem, updatedAt: now() });
          }
          const newEnd = (cur.endAt||now()) + d*60*1000;
          return update(stateRef,{ baselineSec: base, endAt: newEnd, updatedAt: now() });
        };
      });

      // Reset / Stop
      $("#reset").onclick = async () => {
        const cur=await read(); const base=cur.baselineSec||0;
        const s=now(), e=s+base*1000;
        await update(stateRef,{ startedAt:s, endAt:e, paused:false, pausedAt:0, pausedRemaining:0, updatedAt: now() });
      };
      $("#stop").onclick = async () => {
        await update(stateRef,{ baselineSec:0, startedAt:0, endAt:0, paused:false, pausedAt:0, pausedRemaining:0, updatedAt: now() });
      };

      // Pause / Resume / Toggle
      $("#pause").onclick = async () => {
        const cur=await read(); if(cur.paused) return;
        const rem = Math.max(0, (cur.endAt||now())-now());
        await update(stateRef,{ paused:true, pausedAt:now(), pausedRemaining:rem, updatedAt: now() });
      };
      $("#resume").onclick = async () => {
        const cur=await read(); if(!cur.paused) return;
        const newEnd = now() + Math.max(0, cur.pausedRemaining||0);
        await update(stateRef,{ paused:false, pausedAt:0, endAt:newEnd, pausedRemaining:0, updatedAt: now() });
      };
      $("#toggle").onclick = async () => {
        const cur=await read();
        if (cur.paused) return $("#resume").onclick();
        return $("#pause").onclick();
      };

      // Vehicle
      $("#setBus").onclick   = ()=> update(stateRef,{ vehicle:{mode:"image", image:"assets/bus.png"}, updatedAt: now() });
      $("#setPlane").onclick = ()=> update(stateRef,{ vehicle:{mode:"emoji", emoji:"‚úàÔ∏è"}, updatedAt: now() });
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>HUD Controller</h1>
      <div class="muted">Room: marathon-pill-tracker</div>
    </div>

    <datalist id="placesList"></datalist>

    <div class="card">
      <h1>Trip Labels</h1>
      <div class="row">
        <div class="col-6">
          <label>From</label>
          <input id="from" list="placesList" placeholder="Start location"/>
        </div>
        <div class="col-6">
          <label>To</label>
          <input id="to" list="placesList" placeholder="Destination"/>
        </div>
      </div>
      <div class="subtle-sep"></div>
      <div class="btn-row">
        <button id="swap">Swap</button>
        <button id="chain">Chain</button>
        <button id="setLabels">Update Labels</button>
      </div>
    </div>

    <div class="card">
      <h1>ETA Timer</h1>
      <div class="row">
        <div class="col-3">
          <label>Hours</label>
          <input id="hours" type="number" value="0"/>
        </div>
        <div class="col-3">
          <label>Minutes</label>
          <input id="minutes" type="number" value="30" min="0" max="59"/>
        </div>
        <div class="col-12 btn-row">
          <button id="startSet">Start / Set</button>
          <button data-min="+5">+5</button>
          <button data-min="+15">+15</button>
          <button data-min="+60">+60</button>
          <button data-min="-5">-5</button>
          <button id="reset">Reset</button>
          <button id="stop">Stop</button>
        </div>
      </div>
      <div class="subtle-sep"></div>
      <div class="btn-row">
        <button id="pause">Pause</button>
        <button id="resume">Resume</button>
        <button id="toggle">Toggle</button>
      </div>
    </div>

    <div class="card">
      <h1>Vehicle</h1>
      <div class="btn-row">
        <button id="setBus">Driving (üöå)</button>
        <button id="setPlane">In Flight (‚úàÔ∏è)</button>
      </div>
    </div>
  </div>
</body>
</html>
