<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marathon Travel ETA Controller</title>
  <link rel="stylesheet" href="styles.css?v=17" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:#0b0c0f; color:#e7eaf0; }
    .panel { max-width: 780px; margin: 24px auto; background:#12141a; border:1px solid #222736; border-radius:14px; padding:20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:10px 0; }
    label { font-size:12px; opacity:.8; display:block; margin-bottom:6px; }
    input, select, button { background:#0f1117; color:#e7eaf0; border:1px solid #2a3142; border-radius:10px; padding:10px 12px; }
    input[type="number"] { width:100px; }
    button.primary { background:#2463ff; border-color:#2463ff; }
    button.warn { background:#d97706; border-color:#d97706; }
    .pill { padding:8px 12px; border-radius:999px; background:#0f1117; border:1px solid #2a3142; }
    .muted { opacity:.7; font-size:12px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .vehicleBtn { cursor:pointer; }
    .status { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; background:#0b0c0f; border:1px dashed #2a3142; padding:10px; border-radius:8px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Controller ‚Äî Marathon ETA</h2>
    <div class="row">
      <div style="flex:1">
        <label>Room</label>
        <input id="room" class="pill" placeholder="room key" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="saveRoom" class="primary">Use Room</button>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>From</label>
        <input id="from" list="placesList" placeholder="Los Angeles, CA" />
        <datalist id="placesList"></datalist>
      </div>
      <div>
        <label>To</label>
        <input id="to" list="placesList" placeholder="Las Vegas, NV" />
      </div>
    </div>
    <div class="row">
      <button id="applyLabels">Update Labels</button>
    </div>

    <div class="row">
      <div>
        <label>Hours</label>
        <input id="hours" type="number" min="0" value="0" />
      </div>
      <div>
        <label>Minutes</label>
        <input id="minutes" type="number" min="0" value="2" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button id="start" class="primary">Start / Set</button>
        <button id="pause" class="warn">Pause</button>
        <button id="resume">Resume</button>
      </div>
    </div>

    <div class="row">
      <button class="vehicleBtn" id="driveBtn">Driving üöå</button>
      <button class="vehicleBtn" id="planeBtn">Plane ‚úàÔ∏è</button>
    </div>

    <div class="row">
      <button id="add1m">+1m</button>
      <button id="sub1m">-1m</button>
      <button id="add5m">+5m</button>
      <button id="sub5m">-5m</button>
    </div>

    <div class="row">
      <div class="status" id="debug"></div>
    </div>
  </div>

  <script type="module" src="script-controller.js?v=17"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // ---- Firebase config (shared) ----
    const firebaseConfig = {
      apiKey: "AIzaSyB0gJnv1eD4SeXMCRHtFNiHOt122Rbz4XQ",
      authDomain: "subathon-tracker.firebaseapp.com",
      databaseURL: "https://subathon-tracker-default-rtdb.firebaseio.com",
      projectId: "subathon-tracker",
      storageBucket: "subathon-tracker.appspot.com",
      messagingSenderId: "196475311335",
      appId: "1:196475311335:web:ac4411584ea074613ffe42",
      measurementId: "G-ETY652FL4L"
    };

    // ---- App + DB ----
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---- Server time offset ----
    import { ref as dbRef } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    const offsetRef = dbRef(db, ".info/serverTimeOffset");
    let serverOffset = 0;
    onValue(offsetRef, snap => {
      serverOffset = snap.val() || 0;
      logDebug("serverOffset(ms): " + serverOffset);
    });
    const getServerNow = () => Date.now() + serverOffset;

    // ---- UI elems ----
    const E = id => document.getElementById(id);
    const roomInput = E('room');
    const saveRoomBtn = E('saveRoom');
    const fromInput = E('from');
    const toInput = E('to');
    const applyLabelsBtn = E('applyLabels');
    const hoursInput = E('hours');
    const minutesInput = E('minutes');
    const startBtn = E('start');
    const pauseBtn = E('pause');
    const resumeBtn = E('resume');
    const driveBtn = E('driveBtn');
    const planeBtn = E('planeBtn');
    const add1m = E('add1m'); const sub1m = E('sub1m');
    const add5m = E('add5m'); const sub5m = E('sub5m');
    const debug = E('debug');

    // ---- room from URL ----
    const url = new URL(location.href);
    const defaultRoom = url.searchParams.get('room') || 'marathon-pill-tracker';
    roomInput.value = defaultRoom;

    function roomPath() {
      const r = roomInput.value.trim() || 'marathon-pill-tracker';
      return `overlays/${r}/state`;
    }

    function logDebug(s) {
      const now = new Date().toLocaleTimeString();
      debug.textContent = `[${now}] ${s}\n` + debug.textContent;
      console.debug("[CTRL]", s);
    }

    // Listen to current state for visibility
    onValue(ref(db, roomPath()), snap => {
      const val = snap.val();
      logDebug("state: " + JSON.stringify(val, null, 0));
    });

    // ---- Actions ----
    saveRoomBtn.onclick = () => {
      logDebug("Room set to: " + roomInput.value);
    };

    applyLabelsBtn.onclick = async () => {
      const payload = {
        from: fromInput.value || "From",
        to: toInput.value || "To",
        updatedAt: getServerNow()
      };
      await update(ref(db, roomPath()), payload);
      logDebug("Labels updated");
    };

    startBtn.onclick = async () => {
      const h = Number(hoursInput.value || 0);
      const m = Number(minutesInput.value || 0);
      const baselineSec = Math.max(0, h * 3600 + m * 60);
      const now = getServerNow();
      const endAt = now + baselineSec * 1000;

      const payload = {
        baselineSec,
        startedAt: now,
        endAt,
        paused: false,
        pausedAt: 0,
        pausedRemaining: 0,
        updatedAt: now
      };
      await update(ref(db, roomPath()), payload);
      logDebug(`Start/set: baselineSec=${baselineSec}, endAt=${endAt}`);
    };

    pauseBtn.onclick = async () => {
      const now = getServerNow();
      const snap = await (await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js"))
        .get(ref(db, roomPath()));
      const cur = snap.val() || {};
      const remaining = Math.max(0, (cur.endAt || 0) - now);
      await update(ref(db, roomPath()), {
        paused: true,
        pausedAt: now,
        pausedRemaining: remaining,
        updatedAt: now
      });
      logDebug("Paused; remaining(ms)=" + remaining);
    };

    resumeBtn.onclick = async () => {
      const now = getServerNow();
      const snap = await (await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js"))
        .get(ref(db, roomPath()));
      const cur = snap.val() || {};
      const remaining = Math.max(0, cur.pausedRemaining || 0);
      await update(ref(db, roomPath()), {
        paused: false,
        startedAt: now,
        endAt: now + remaining,
        pausedAt: 0,
        pausedRemaining: 0,
        updatedAt: now
      });
      logDebug("Resumed; new endAt=" + (now + remaining));
    };

    async function nudge(deltaMs) {
      const now = getServerNow();
      const snap = await (await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js"))
        .get(ref(db, roomPath()));
      const cur = snap.val() || {};
      if (cur.paused) {
        const pr = Math.max(0, (cur.pausedRemaining || 0) + deltaMs);
        await update(ref(db, roomPath()), {
          pausedRemaining: pr,
          updatedAt: now
        });
        logDebug("Nudged pausedRemaining(ms)=" + pr);
      } else {
        const endAt = Math.max(now, (cur.endAt || now) + deltaMs);
        await update(ref(db, roomPath()), { endAt, updatedAt: now });
        logDebug("Nudged endAt=" + endAt);
      }
    }

    add1m.onclick = () => nudge(60_000);
    sub1m.onclick = () => nudge(-60_000);
    add5m.onclick = () => nudge(5 * 60_000);
    sub5m.onclick = () => nudge(-5 * 60_000);

    driveBtn.onclick = async () => {
      await update(ref(db, roomPath()), {
        vehicle: { mode: "image", image: "assets/bus.png" },
        updatedAt: getServerNow()
      });
      logDebug("Vehicle: driving");
    };
    planeBtn.onclick = async () => {
      await update(ref(db, roomPath()), {
        vehicle: { mode: "emoji", emoji: "‚úàÔ∏è" },
        updatedAt: getServerNow()
      });
      logDebug("Vehicle: plane");
    };
  </script>
</body>
</html>
