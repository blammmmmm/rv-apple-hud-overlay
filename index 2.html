<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RV HUD Controller</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
    aside { padding: 16px; border-right: 1px solid #e2e8f0; overflow: auto; }
    main { display: grid; place-items: center; background: #0b1020; }
    iframe { width: 92%; height: 92%; border: 1px solid #334155; border-radius: 12px; background: #000; }
    h2 { margin: 10px 0; }
    fieldset { border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; margin-bottom: 12px; }
    legend { padding: 0 6px; font-weight: 700; }
    label { display: block; font-size: 12px; color: #334155; margin-top: 6px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; }
    textarea { min-height: 90px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button { margin-top: 8px; padding: 8px 10px; border-radius: 8px; border: 1px solid #0ea5e9; background: #0ea5e9; color: white; cursor: pointer; }
    button.secondary { background: white; color: #0ea5e9; }
    .small { font-size: 12px; color: #64748b; }
    .slider { width: 100%; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
  </style>
</head>
<body>
  <aside>
    <h2>RV HUD Controller</h2>
    <div class="small">Open your overlay URL in the right panel and control it here.</div>
    <label>Overlay URL</label>
    <input id="overlayUrl" placeholder="https://yourdomain/rv-apple-hud-overlay/index.html?states=...&rv=...">
    <button id="loadBtn">Load Overlay</button>

    <fieldset>
      <legend>Trip Labels</legend>
      <label>From (state)</label>
      <input id="from" placeholder="California">
      <label>To (state)</label>
      <input id="to" placeholder="Arizona">
      <button id="sendLabels">Send Labels</button>
    </fieldset>

    <fieldset>
      <legend>ETA Mode</legend>
      <div class="row">
        <div>
          <label>Auto ETA: Speed</label>
          <input id="speed" type="number" placeholder="mph (e.g., 58)">
        </div>
        <div>
          <label>Fixed ETA (ISO)</label>
          <input id="eta" placeholder="2025-10-22T03:00:00Z">
        </div>
      </div>
      <button id="sendEta">Apply ETA Mode</button>
    </fieldset>

    <fieldset>
      <legend>Pause / Resume</legend>
      <label>Reason (optional)</label>
      <input id="pauseReason" placeholder="Bathroom break">
      <div class="row3">
        <div>
          <label>Minutes</label>
          <input id="pauseMinutes" type="number" min="0" step="1" placeholder="10">
        </div>
        <div><button id="pauseBtn">Pause</button></div>
        <div><button class="secondary" id="resumeBtn">Resume</button></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Planned Route (polyline)</legend>
      <label>Paste lon,lat per line</label>
      <textarea id="polyline" placeholder="-118.2437,34.0522
-115.1398,36.1699
-112.0740,33.4484"></textarea>
      <div class="row">
        <div>
          <label>Start Covered (distance)</label>
          <input id="covered" type="number" value="0">
        </div>
        <div>
          <label>Unit</label>
          <select id="unit">
            <option value="mi">mi</option>
            <option value="km">km</option>
          </select>
        </div>
      </div>
      <button id="sendRoute">Send Route</button>
    </fieldset>

    <fieldset>
      <legend>Live GPS (manual)</legend>
      <div class="row">
        <div>
          <label>Lon</label>
          <input id="lon" type="number" step="0.000001" placeholder="-116.12">
        </div>
        <div>
          <label>Lat</label>
          <input id="lat" type="number" step="0.000001" placeholder="36.080000">
        </div>
      </div>
      <button id="sendPoint">Send GPS Point</button>
    </fieldset>

    <fieldset>
      <legend>Vehicle</legend>
      <label>RV Image URL (PNG/WebP)</label>
      <input id="rvUrl" placeholder="assets/myRV.webp">
      <button id="swapRv">Swap Icon</button>
    </fieldset>
  </aside>

  <main>
    <iframe id="overlay" src="about:blank"></iframe>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const frame = $('overlay');

    $('loadBtn').onclick = () => {
      frame.src = $('overlayUrl').value.trim();
    };

    function post(msg){
      const w = frame.contentWindow;
      if (!w) { alert('Load the overlay first'); return; }
      w.postMessage(msg, '*');
    }

    $('sendLabels').onclick = () => {
      post({ type:'rv:update', from: $('from').value, to: $('to').value });
    };

    $('sendEta').onclick = () => {
      const speed = Number($('speed').value);
      const eta = $('eta').value.trim();
      const msg = { type:'rv:update' };
      if (!isNaN(speed) && speed > 0) msg.speed = speed;
      if (eta) msg.eta = eta;
      post(msg);
    };

    function parsePolyline(){
      const text = $('polyline').value.trim();
      const lines = text.split(/\n+/).map(s => s.trim()).filter(Boolean);
      const coords = lines.map(line => {
        const [lon, lat] = line.split(',').map(Number);
        return [lon, lat];
      }).filter(p => Array.isArray(p) && p.length===2 && !Number.isNaN(p[0]) && !Number.isNaN(p[1]));
      return coords;
    }

    $('sendRoute').onclick = () => {
      const coords = parsePolyline();
      if (coords.length < 2) { alert('Need at least two points'); return; }
      const msg = {
        type: 'gps:route',
        coords,
        covered: Number($('covered').value) || 0,
        from: $('from').value,
        to: $('to').value
      };
      post(msg);
    };

    $('sendPoint').onclick = () => {
      const lon = Number($('lon').value);
      const lat = Number($('lat').value);
      const speedVal = Number($('speed').value);
      const msg = { type:'gps:point', lon, lat };
      if (!Number.isNaN(speedVal) && speedVal > 0) msg.speed = speedVal;
      post(msg);
    };

    $('swapRv').onclick = () => {
      const url = $('rvUrl').value.trim();
      if (!url) return;
      post({ type:'rv:update', rv: url });
    };

    // Pause / Resume
    $('pauseBtn').onclick = () => {
      const reason = $('pauseReason').value.trim();
      const minutes = Number($('pauseMinutes').value);
      const payload = { type: 'rv:pause' };
      if (reason) payload.reason = reason;
      if (!Number.isNaN(minutes) && minutes > 0) payload.minutes = minutes;
      post(payload);
    };
    $('resumeBtn').onclick = () => {
      post({ type:'rv:resume' });
    };
  </script>
</body>
</html>
